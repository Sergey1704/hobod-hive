# Домашнее задание по Hive

## Входные данные
В соответствии с [Федеральным законом](http://pravo.gov.ru/proxy/ips/?docbody=&prevDoc=102402993&backlink=1&&nd=102452026), использование кассовых аппаратов контролируется автоматизированной системой контроля применения контрольно-кассовой техники ФНС. Данные о транзакциях на контрольно-кассовых терминалах (далее ККТ) поступают в ФНС и сохраняются в распределенной файловой системе hdfs. В данных о транзакциях совершенных на ККТ представлены в текстовом виде, каждая строка отдельная транзакция. Данные о конкретной транзакции описаны в формате json-объекта. Формат полей json-объекта описан в [протоколе](http://kktspb.ru/PravoKKT/FNC/2017/www_protokol_informacionnogo_obmena_ofd-fns_ver_3..pdf), см. таблицу “Бланк строгой отчётности” на с.9-10. Не все поля json-объекта обязательны для заполнения, в случае незаполненного поля его значение или пусто, или равно null, или отсутствует в json-объекте. Транзакции с данных по различным ККТ хранятся вместе (в одном файле содержиться информация о многих ККТ). Каждый ККТ имеет владельца - налогоплательщика. Налогоплательщик определяется своим ИНН. У налогоплательщика может быть один или несколько  ККТ, но каждый ККТ принадлежит только одному налогоплательщику и определяется уникально своим номером. В каждой транзакции содержится информация о номере ККТ (поле **"kktRegId"**), налогоплательщике, которому принадлежит данный ККТ (поле **"userInn"**), также есть поле определяющее тип транзакции  (**"subtype"**).
Путь к данным: Полные данные с реальными UserINN: **/data/hive/fns2**.

## Задания
**1.** В данной задаче необходимо создать базу данных. В базе данных необходимо создать таблицу/таблицы в hive для работы с данными о транзакциях на ККТ. В таблице необходимо провести извлечение значений полей json-объектов в значения колонок таблиц hive. В случае невозможности извлечения вложенных полей json-объектов, возможно оставить значением столбца в таблице hive как текст, json-объект как строка. 
Результатом по данной задаче будет выборка первых 50 строк из созданной вами таблицы с данными о транзакциях ККТ.

**2.** В созданной базе данных необходимо создать таблицы с данными о транзакциях ККТ в дополнительных трех различных форматах: Text, ORC и Parquet, также необходимо сравнить скорость работы для каждого формата на следующего запроса: 
Выбрать налогоплательщика с наибольшей прибылью. Уникальный налогоплательщик определяется полем **content.userInn**, сумма для транзакции определена только для транзакций типа **"subtype": "receipt"**, сумма транзакции определена в поле **"totalSum"** в json-объекте транзакции ККТ. Вывести ответ в формате: **налогоплательщик \</t> прибыль**.
В задаче необходимо сравнить время выполнения данного запроса для трех созданных таблиц.

**3.** Необходимо написать запрос выбирающий для каждого налогоплательщика наиболее прибыльный день в месяце. Уникальный налогоплательщик определяется полем **content.userInn**, сумма для транзакции определена только для транзакций типа **"subtype": "receipt"** (остальные типы можно не учитывать), сумма транзакции определена в поле **"totalSum"** в json-объекте транзакции ККТ. Дата и время берутся из поля **content.dateTime**.

**4.** Необходимо написать запрос выбирающий налогоплательщиков, для которых средняя прибыль одной транзакции в первой половине дня (с начала дня до 13.00, не включая 13:00) строго больше средней прибыли одной транзакции во второй половине дня (после 13.00 до конца дня). Дата и время берутся из поля **content.dateTime**. Вывести результат в формате <UserINN прибыль_утром прибыль_вечером>. Отсортировать по значениями утренней прибыли. Прибыль округлить до целых.

**5.** Необходимо написать запрос выполняющий поиск налогоплательщиков нарушающих п. 2 ст.4.3 закона 54-ФЗ от 03.07.16. Нарушение состоит в том, что для отдельно взятого ККТ налогоплательщика транзакция “кассовый чек” (**"subtype": "receipt"**) была совершена по оси времени между транзакцией “закрытие смены” (**"subtype": "closeShift"**) и транзакцией “открытие смены” (**"subtype": "openShift"**). В запросе необходимо найти налогоплательщиков, у которых есть ККТ с нарушением порядка транзакций. Налогоплательщиков, совершивших транзакции до 1-го открытия кассы или после последнего закрытия, также считаем нарушителями.

